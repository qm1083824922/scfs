<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>瑞翰供应链</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
</head>
<body>
	<div class="wrapper mb20">
		<h4 class="title mb10 ml5 mt5">
			<strong>财务审核</strong>
		</h4>
		<form class="audit-form">
			<p>
				<span class="form-label">费用编号</span> <span
					class="form-value js-initform" id="feeNo"></span>
			</p>
			<p>
				<span class="form-label">项目</span> <span
					class="form-value js-initform" id="projectName"></span>
			</p>
			<p>
				<span class="form-label">应付客户</span> <span
					class="form-value js-initform" id="custReceiverName"></span>
			</p>
			<p>
				<span class="form-label">应付费用科目</span> <span
					class="form-value js-initform" id="payFeeSpecName"></span>
			</p>
			<p>
				<span class="form-label">应付辅助科目</span> <span
					class="form-value js-initform" id="payAssistFeeSpecName"></span>
			</p>
			<p>
				<span class="form-label">应付方式</span> <span
					class="form-value js-initform" id="payTypeName"></span>
			</p>
			<p>
				<span class="form-label">应付日期</span> <span
					class="form-value js-initform" id="payDate"></span>
			</p>
			<p>
				<span class="form-label">币种</span> <span
					class="form-value js-initform" id="currencyTypeName"></span>
			</p>
			<p>
				<span class="form-label">应付金额</span> <span
					class="form-value js-initform" id="payAmount"></span>
			</p>
			<p>
				<span class="form-label">已付金额</span> <span
					class="form-value js-initform" id="paidAmount"></span>
			</p>
			<p>
				<span class="form-label">已收票金额</span> <span
					class="form-value js-initform" id="acceptInvoiceAmount"></span>
			</p>
			<p>
				<span class="form-label">收票方式</span> <span
					class="form-value js-initform" id="acceptInvoiceTypeName"></span>
			</p>
			<p>
				<span class="form-label">收票税率</span> <span
					class="form-value js-initform" id="acceptInvoiceTaxRate"></span>
			</p>
			<p>
				<span class="form-label">备注</span> <span
					class="form-value js-initform" id="payNote"></span>
			</p>
		</form>

		<!-- 审核记录 -->
		<h4 class="title mb10 ml5 mt5 audit-record-title">
			<strong>审核节点</strong>
		</h4>
		<div class="audit-record-box">
			<ul>
				<li class="passed">
					<p>李伟龙 已提交 （已通过）审核意见</p>
					<p>2017-04.12 10:01:25</p>
				</li>
				<li class="node">
					<p>风控审核 刘声娟（已通过）审核意见</p>
					<p>2017-04.12 10:01:25</p>
				</li>
				<li class="node">
					<p>财务专员审核 林春燕（已通过）审核意见</p>
					<p>2017-04.12 10:01:25</p>
				</li>
				<li class="node reject">
					<p>财务主管审核 林莉（已驳回）</p>
					<p>2017-04.12 10:01:25</p>
				</li>
				<li class="node">
					<p>业务主管审核 刘毅（未审核）</p>
					<p>2017-04.12 10:01:25</p>
				</li>
				<li class="node">
					<p>总经理审核 徐总（未审核）</p>
					<p>2017-04.12 10:01:25</p>
				</li>
			</ul>
		</div>

		<div class="box-footer text-center mb10">
			<div class="form-inline" id="buttom1">
				<textarea class="form-control js-initform" id="suggestion" rows="3"
					name="suggestion" placeholder="审核意见"></textarea>
				<p class="mt20">
					<button type="button" data-permissionUrl="/fee/finance2/pass/audit"
						data-url="fee/finance2/pass/audit" class="btn btn-primary btn-sm"
						id="pass">审核通过</button>
					<button type="button" data-permissionUrl="/fee/unpass/audit"
						data-url="fee/unpass/audit" class="btn btn-primary btn-sm punpass"
						id="unpass">审核不通过</button>
					<button type="button" class="btn btn-default btn-sm js-back">返回</button>
				</p>
				<div class="row mt20 psigh" style="display: none">
					<label class="control-label col-md-2">加签给:</label> <select
						class="form-control col-md-8 js-select" data-url="USER"
						id="sighId" name="sighId"></select>
					<button type="button" data-permissionUrl="/fee/sigh/audit"
						data-url="fee/sigh/audit" class="btn btn-primary btn-sm col-md-2"
						id="sigh">加签</button>
				</div>
				<div class="row mt20 pdeliver" style="display: none">
					<label class="form-control col-md-8 js-select">转交给:</label> <select
						class="form-control js-select" data-url="USER" id="deliverId"
						name="deliverId"></select>
					<button type="button" data-permissionUrl="/fee/deliver/audit"
						data-url="fee/deliver/audit"
						class="btn btn-primary btn-sm col-md-2" id="deliver">转交</button>
				</div>
			</div>
			<div class="form-inline" style="display: none" id="buttom2">
				<p class="mt20">
					<button type="button" class="btn btn-default btn-sm js-back">返回</button>
				</p>
			</div>
		</div>
	</div>
	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js?v=1.0.0"></script>
	<script> 
			var id = GLOBAL.getParam("id");
			var poId = GLOBAL.getParam("poId");  
			var flag = GLOBAL.getParam("flag");

			if(flag){
			    $('#buttom2').show();
			    $('#buttom1').hide();
			}

			$(function() {
				var callback = function(reply) {
					var data = reply.items;
					for ( var i in data) {
						var value = data[i];
						var element = $("#" + i) ;
						if (element.hasClass("cash")) {
							element.text(value == null ? "" : value.toThounds());
						}else {
							element.text(value == null ? "" : value);
						}
					}
				}

				GLOBAL.ajax("fee/info/audit", {feeId: poId}, callback);
				//获取审核记录数据并在表格中展示
			    GLOBAL.ajax('/fee/auditflow/audit/query', {
			    	feeId: poId
			    }, function(e) {
			        var data = e.items;
			        if (data) {
                        var nodeLists = "";
                        for (var i = 0; i < data.length; i++) {

                            var bgFlag = data[i].backcolor,
                                fontFlag = data[i].fontcolor;
                            var state;
                            if(bgFlag == 1){
                                state = "passed"
                            }
                            if(fontFlag == "1"){
                                state = "reject";
                            }else if(fontFlag == "2"){
                                state = "current";
                            }
                            nodeLists += '<li class="'+state+'"><p>' + data[i].stateName + ' ' + data[i].createTime + ' (' + data[i].auditStateName + ') ' + data[i].suggestion + '<p>' + (data[i].createTime || "-") + '</p></li>'
                        }
                        $('.audit-record-box ul').empty().append(nodeLists);
                    }
		    	})
		    	
		        GLOBAL.ajax('audit/id/query', {
		            id: id
		        }, function(e) {
		            var data = e.items;
		            if (data) {
		                if (data.auditType == 1 || data.auditType == 2) {
		                    $(".psigh,.pdeliver").show();
		                } else {
		                    $(".punpass").hide();
		                }
		                if(data.auditState == 1 || data.auditState == 3){//审核通过，隐藏
		                    $('#buttom2').show();
		                    $('#buttom1').hide();
		                }
		            }
		        });
			})
			
			GLOBAL.initSelect();
			$("#pass").click(function() {
				var suggestion = $("#suggestion").val();
				var url = $(this).data("url");
				GLOBAL.ajax(url, {
					auditId : id,
					feeId : poId,
					suggestion : suggestion || ""
				}, function(e) {
					if (e.success) {
						MOBILE.msg("审核通过成功！", function(){
			        		window.location.href = "audit_list_new.html";
			        	}); 
					} else {
						MOBILE.msg(e.msg);
					}
				});
			})

			$("#unpass").click(function() {
				var suggestion = $("#suggestion").val();
				if (!suggestion) {
					MOBILE.msg("请输入审核意见");
					return;
				}
				var url = $(this).data("url");
				GLOBAL.ajax(url, {
					auditId :  id,
					feeId :  poId,
					suggestion : suggestion
				}, function(e) {
					if (e.success) {
						MOBILE.msg("审核不通过成功！", function(){
			        		window.location.href = "audit_list_new.html";
			        	}); 
					} else {
						MOBILE.msg(e.msg);
					}
				});
			})

			$(".js-back").click(function(){
			   	window.location.href = "audit_list_new.html";
			})
			$("#sigh").click(function(){
		        var url = $(this).data("url");
		        var sighId = $("#sighId").val();
		        if(sighId){
		            MOBILE.confirm('确定加签吗？' , function(){
		                GLOBAL.ajax(url, {auditId: id, pauditorId: sighId}, function(e) {
				            if (e.success) {
				                MOBILE.msg("加签成功！", function(){
			                		window.location.href = "audit_list_new.html";
			                	});   
				            } else {
				                MOBILE.msg(e.msg);
				            }
				        });
		            });
		        }else{
		            MOBILE.msg("请选择！");
		            $("#sighId").focus();
		        }
		    })
		    
		    $("#deliver").click(function(){
		        var url = $(this).data("url");
		        var deliverId = $("#deliverId").val();
		        if(deliverId){
		          MOBILE.confirm('确定转交吗？' , function(){
		              	GLOBAL.ajax(url, {auditId: id, pauditorId: deliverId}, function(e) {
				            if (e.success) {
				                MOBILE.msg("转交成功！", function(){
			                		window.location.href = "audit_list_new.html";
			                	}); 
				            } else {
				                MOBILE.msg(e.msg);
				            }
				        });
		          });
		        }else{
		            MOBILE.msg("请选择！");
		            $("#deliverId").focus();
		        }
		    })
			$(".js-back").click(function(){
			    if(flag){
			        location.href = "myApplying.html";
			    }else{
			        window.location.href = "audit_list_new.html";;
			    }
			})
		</script>
</body>
</html>
