<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>供应链金融</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
</head>
<body>
	<div class="wrapper mb20">
		<div class="box no-margin">
			<form class="audit-form" id="form1" data-url="projectItem/info/audit">
				<div class="box-body">
					<input class="form-control js-initform" type="hidden" id="id"
						name="id">
					<h4 class="title mb10 ml5 mt5">
						<strong>风控审核</strong>
					</h4>
					<table class="table table-bordered table-hover no-margin">
						<tr>
							<td width="200" class="text-right"><b>编号：</b></td>
							<td class="text-left"><label class="js-initform" id="itemNo">
							</label></td>
						</tr>
						<tr>
							<td width="200" class="text-right"><b>项目：</b></td>
							<td class="text-left"><label class="js-initform"
								id="projectName"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>业务类型：</b></td>
							<td class="text-left"><label class="js-initform"
								id="businessType"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>有效期：</b></td>
							<td class="text-left"><label class="js-initform"
								id="startDate"></label> - <label class="js-initform"
								id="endDate"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>额度总额：</b></td>
							<td class="text-left"><label class="js-initform"
								id="totalAmountValue"></label> <label class="js-initform"
								id="amountCurrencyValue"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>单笔额度：</b></td>
							<td class="text-left"><label class="js-initform"
								id="singleAmountValue"></label> <label class="js-initform"
								id="amountCurrencyValue"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>结算类型：</b></td>
							<td class="text-left" id="service"><label
								class="js-initform" id="isFundAccountName"> </label></td>
						</tr>
						<tr id="fundAccountPeriod1">
							<td class="text-right"><b>合作账期： </b></td>
							<td class="text-left"><label class="js-initform"
								id="fundAccountPeriod"> </label>天</td>
						</tr>
						<tr id="fundMonthRate1">
							<td class="text-right"><b>日服务费率： </b></td>
							<td class="text-left"><label class="js-initform"
								id="fundMonthRate"> </label></td>
						</tr>
						<tr id="dayPenalRate1">
							<td class="text-right"><b>日违约金费率： </b></td>
							<td class="text-left"><label class="js-initform"
								id="dayPenalRate"> </label></td>
						</tr>
						<tr id="penalGracePeriod1">
							<td class="text-right"><b id="penalGracePeriod1">违约宽限期：
							</b></td>
							<td class="text-left"><label class="js-initform"
								id="penalGracePeriod"> </label>天</td>
						</tr>
						<tr id="minSaleDay1">
							<td class="text-right"><b>最低消费天数：</b></td>
							<td class="text-left"><label class="js-initform"
								id="minSaleDay"> </label>天</td>
						</tr>
						<tr id="fixedpoints1">
							<td class="text-right"><b>是否固定点数： </b></td>
							<td class="text-left"><label class="js-initform"
								id="fixedpointsValue"> </label></td>
						</tr>
						<tr id="spreadfixedpoints1">
							<td class="text-right"><b id="priceregular">价差固定点数： </b></td>
							<td class="text-left" id="service"><label
								class="js-initform" id="spreadfixedpoints"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>计算操作费：</b></td>
							<td class="text-left"><label class="js-initform"
								id="isOperateAccountValue"> </label></td>
						</tr>
						<tr id="operateFeeRate1">
							<td class="text-right"><b>操作服务费率：</b></td>
							<td class="text-left"><label class="js-initform"
								id="operateFeeRate"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>项目对账方式：</b></td>
							<td class="text-left"><label class="js-initform"
								id="projectchecktypeValue"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>项目对账日期：</b></td>
							<td class="text-left"><label class="js-initform"
								id="projectcheckdate"> </label>号</td>
						</tr>
						<tr>
							<td class="text-right"><b>客户对账方式：</b></td>
							<td class="text-left"><label class="js-initform"
								id="clientchecktypeValue"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>客户对账日期：</b></td>
							<td class="text-left"><label class="js-initform"
								id="clientCheckDay"></label>号</td>
						</tr>
						<tr>
							<td class="text-right"><b>供应商对账方式：</b></td>
							<td class="text-left"><label class="js-initform"
								id="supplierchecktypeValue"> </label></td>
						</tr>
						<tr>
							<td class="text-right"><b>供应商对账日期：</b></td>
							<td class="text-left"><label class="js-initform "
								id="supplierCheckDay"></label>号</td>
						</tr>
						<tr>
							<td class="text-right"><b>预收客户比例：</b></td>
							<td class="text-left"><label class="js-initform"
								id="payRate"></label></td>
						</tr>
						<tr>
							<td class="text-right"><b>代理出口：</b></td>
							<td class="text-left"><label class="js-initform"
								id="isAgencyExportValue"> </label></td>
						</tr>
						<tr id="agencyExportRate1">
							<td class="text-right"><b>代理出口费率：</b></td>
							<td class="text-left"><label class="js-initform"
								id="agencyExportRate"></label></td>
						</tr>
						<tr>
							<td class="text-right"><b>代理进口：</b></td>
							<td class="text-left"><label class="js-initform"
								id="isagencyimportValue"> </label></td>
						</tr>
						<tr id="agencyimportrate1">
							<td class="text-right"><b>代理进口费率：</b></td>
							<td class="text-left"><label class="js-initform"
								id="agencyimportrate"></label></td>
						</tr>
						<tr>
							<td class="text-right"><b>结算汇率：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="accountRateTypeValue"> </label></td>
						</tr>
						<tr id="bankId1">
							<td class="text-right"><b>银行名称：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="bankName"> </label></td>
						</tr>
						<tr id="accountRate1">
							<td class="text-right"><b>固定汇率：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="accountRate"></label></td>
						</tr>
						<tr>
							<td class="text-right"><b>签收标准：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="signStandardValue"></label></td>
						</tr>
						<tr id="certificateName1" style="display: none;">
							<td class="text-right"><b>姓名：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="certificateName"></label></td>
						</tr>
						<tr id="certificateId1" style="display: none;">
							<td class="text-right"><b>身份证号码：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="certificateId"></label></td>
						</tr>
						<tr id="officialSeal1" style="display: none;">
							<td class="text-right"><b>公章名：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="officialSeal"></label></td>
						</tr>
						<tr>
							<td class="text-right"><b>库龄期限：</b></td>
							<td class="text-left" id="regular"><label
								class="js-initform" id="libraryAge"></label></td>
						</tr>
						<tr>
							<td class="text-right"><b>备注：</b></td>
							<td class="text-left"><label class="js-initform" id="remark"></label>
							</td>
						</tr>
					</table>
				</div>
				<div class="box-body">
					<h4 class="title mb10 ml5 mt5">
						<strong>审核记录</strong>
					</h4>
					<table id="js_audit_dataTable" class="table table-border"></table>
				</div>
				<!-- .box-body -->
				<div class="box-footer text-center mb10">
					<div class="form-inline" id="buttom1">
						<textarea class="form-control js-initform" id="suggestion"
							rows="3" name="suggestion" placeholder="审核意见"></textarea>
						<p class="mt20">
							<button type="button" data-url="projectItem/risk/audit"
								data-permissionUrl="/projectItem/risk/audit"
								class="btn btn-primary btn-sm" id="pass">审核通过</button>
							<button type="button" data-url="projectItem/unpass/audit"
								data-permissionUrl="/projectItem/unpass/audit"
								class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
						<div class="row mt20 psigh" style="display: none">
							<label class="control-label col-md-2">加签给:</label> <select
								class="form-control col-md-8 js-select" data-url="USER"
								id="sighId" name="sighId"></select>
							<button type="button" data-url="projectItem/sigh/audit"
								data-permissionUrl="/projectItem/sigh/audit"
								class="btn btn-primary btn-sm col-md-2" id="sigh">加签</button>
						</div>
						<div class="row mt20 pdeliver" style="display: none">
							<label class="control-label col-md-2">转交给:</label> <select
								class="form-control col-md-8 js-select" data-url="USER"
								id="deliverId" name="deliverId"></select>
							<button type="button" data-url="projectItem/deliver/audit"
								data-permissionUrl="/projectItem/deliver/audit"
								class="btn btn-primary btn-sm col-md-2" id="deliver">转交</button>
						</div>
					</div>
					<div class="form-inline" style="display: none" id="buttom2">
						<p class="mt20">
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
					</div>
				</div>
				<!-- /.box-footer -->
			</form>
		</div>
	</div>
	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js?v=1.0.0"></script>
	<script>  
var id = GLOBAL.getParam("id");
var poId = GLOBAL.getParam("poId"); 
var flag = GLOBAL.getParam("flag");

if(flag){
    $('#buttom2').show();
    $('#buttom1').hide();
}

$(function() {

    var $from = $("#form1");
    var url = $from.data("url");
    GLOBAL.ajax(url, {
        projectItemId: poId
    }, function(e) {
        if (e.success) {
            var data = e.items.projectItem;
            if (data) {
                $(".js-initform", $from).each(function() {
                    var $this = $(this);
                    var id = $this.attr("id");
                    data[id] = data[id] == null ? "" : data[id];

                    if (this.nodeName.toLowerCase() == "span") {
                        if (data[id] || data[id] == 0) {
                            $this.text(data[id]);
                        }
                    } else {
                        $this.val(data[id]);
                    }
                });
                GLOBAL.ajax('audit/id/query', {
                    id: id
                }, function(e) {
                    var data = e.items;
                    if (data) {
                        if (data.auditType == 1 || data.auditType == 2) {
                            $(".psigh,.pdeliver").show();
                        } else {
                            $(".punpass").hide();
                        }
                        if(data.auditState == 1 || data.auditState == 3){//审核通过，隐藏
                            $('#buttom2').show();
                            $('#buttom1').hide();
                        }
                    }
                });
            } 
        }
      //获取审核记录数据并在表格中展示
        GLOBAL.ajax('projectItem/auditflow/audit/query', {
        	projectItemId: poId
        }, function(e) {
            var data = e.items;
            if (data) {
                var tabStr = "";
                for (var i = 0; i < data.length; i++) {

                    var bgFlag = data[i].backcolor,
                        fontFlag = data[i].fontcolor;

                    if(bgFlag || fontFlag){
                        var backcolor = ["", "#d0daf2"],
                            fontColor = ["", "red", "blue"];
                    }
                    if(bgFlag == 2){
                        var borderColor = "";
                    }

                    tabStr += '<tbody><tr><td rowspan="4" class="column-index" style="background-color: ' + backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '">' + (i + 1) + '</td></tr><tr style="background-color: ' + 
		        			backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '"><td style="width:1rem">节点：</td><td style="width:4rem">' + data[i].stateName +"<span>("+data[i].auditStateName+ ')</span></td><td style="width:1.5rem">处理人：</td>' + '<td>' + data[i].dealName + '</td></tr><tr style="background-color: ' + backcolor[bgFlag] + ';color: ' +
		        			fontColor[fontFlag] + '"><td>时间：</td><td colspan="3">' + data[i].createTime + '&nbsp;&nbsp;-&nbsp;&nbsp;' + data[i].dealTime + '</td></tr><tr style="background-color: ' + backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '"><td>意见：</td><td colspan="3">' + data[i].suggestion + 
		        			'</td></tr>' + '<tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                }
                $('#js_audit_dataTable').append(tabStr);
            }
        }) 
    });
    if ($("#isFundAccountName").html() == "资金占用") {
        $("#fundAccountPeriod1").show();
        $("#fundMonthRate1").show();
        $("#dayPenalRate1").show();
        $("#penalGracePeriod1").show();
        $("#minSaleDay1").show();
        $("#fixedpoints1").hide();
        $("#spreadfixedpoints1").hide();
    } else if ($("#isFundAccountName").html() == "价差") {
        $("#fundAccountPeriod1").hide();
        $("#fundMonthRate1").hide();
        $("#dayPenalRate1").hide();
        $("#penalGracePeriod1").hide();
        $("#fixedpoints1").show();
        $("#spreadfixedpoints1").show();
        $("#minSaleDay1").hide();
    }
    if ($("#accountRateTypeValue").html() == "固定汇率") {
        $("#accountRate1").show();
        $("#bankId1").hide().find("#bankName").val("");
    } else if ($("#accountRateTypeValue").html() == "结算日汇率") {
        $("#bankId1").show();
        $("#accountRate1").hide().find("#accountRate").val("");
    }
    if ($("#isOperateAccountValue").html() == "无") {
        $("#operateFeeRate1").hide().find("#operateFeeRate").val("");
    }
    if ($("#isAgencyExportValue").html() == "否") {
        $("#agencyExportRate1").hide().find("#agencyExportRate").val("");
    }
    if ($("#isagencyimportValue").html() == "否") {
        $("#agencyimportrate1").hide().find("#agencyimportrate").val("");

    }
    if ($("#fixedpointsValue").html() == "否") {
        $("#spreadfixedpoints1").hide().find("#spreadfixedpoints").val("");
    }
    if ($("#signStandardValue").html() == "身份证") {
        $("#certificateName1").show();
        $("#certificateId1").show();
    } else if ($("#signStandardValue").html() == "公章") {
        $("#officialSeal1").show();
    } else
    if ($("#signStandardValue").html() == "身份证+公章") {
        $("#certificateName1").show();
        $("#certificateId1").show();
        $("#officialSeal1").show();
    }
})
GLOBAL.initSelect();
$("#pass").click(function() {
    var suggestion = $("#suggestion").val();
    var url = $(this).data("url");
    GLOBAL.ajax(url, {
        auditId: id,
        projectItemId: poId,
        suggestion: suggestion || ""
    }, function(e) {
        if (e.success) { 
            MOBILE.msg("审核通过成功！", function(){
        		window.location.href = "audit_list_new.html";
        	}); 
        } else {
        	MOBILE.msg(e.msg);
        }
    });
})

$("#sigh").click(function() {
    var url = $(this).data("url");
    var sighId = $("#sighId").val();
    if (sighId) {
        MOBILE.confirm('确定加签吗？', function() {
            GLOBAL.ajax(url, {
                auditId: id,
                pauditorId: sighId
            }, function(e) {
                if (e.success) {
                    MOBILE.msg("加签成功！", function(){
                		window.location.href = "audit_list_new.html";
                	});  
                } else {
                	MOBILE.msg(e.msg);
                }
            });
        });
    } else {
        MOBILE.msg("请选择！");
        $("#sighId").focus();
    }
})

$("#deliver").click(function() {
    var url = $(this).data("url");
    var deliverId = $("#deliverId").val();
    if (deliverId) {
        MOBILE.confirm('确定转交吗？', function() {
            GLOBAL.ajax(url, {
                auditId: id,
                pauditorId: deliverId
            }, function(e) {
                if (e.success) {
                	MOBILE.msg("转交成功！", function(){
                		window.location.href = "audit_list_new.html";
                	});
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        });
    } else {
        MOBILE.msg("请选择！");
        $("#deliverId").focus();
    }
})

$("#unpass").click(function() {
    var suggestion = $("#suggestion").val();
    if (!suggestion) {
        MOBILE.msg("请输入审核意见");
        return;
    }
    var url = $(this).data("url");
    GLOBAL.ajax(url, {
        auditId:id,
        projectItemId: poId,
        suggestion: suggestion
    }, function(e) {
        if (e.success) { 
            MOBILE.msg("审核不通过成功！", function(){
            	window.location.href = "audit_list_new.html";
            });
        } else {
            MOBILE.msg(e.msg);
        }
    });
})

$(".js-back").click(function(){
    if(flag){
        location.href = "myApplying.html";
    }else{
        window.location.href = "audit_list_new.html";;
    }
})
</script>
</body>

</html>
